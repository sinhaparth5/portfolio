---
const { mediumUrl } = Astro.props;

interface BlogPost {
  title: string;
  link: string;
  pubDate: string;
  description: string;
  categories: string[];
}

let blogs: BlogPost[] = [];

try {
  // Extract username from Medium URL
  const username = mediumUrl.replace('https://', '').replace('.medium.com', '').replace('medium.com/@', '');
  const rssFeedUrl = `https://medium.com/feed/@${username}`;

  const response = await fetch(rssFeedUrl);
  if (response.ok) {
    const xmlText = await response.text();

    // Parse RSS feed (simple parser)
    const items = xmlText.match(/<item>[\s\S]*?<\/item>/g) || [];

    blogs = items.slice(0, 3).map(item => {
      const titleMatch = item.match(/<title><!\[CDATA\[(.*?)\]\]><\/title>/);
      const linkMatch = item.match(/<link>(.*?)<\/link>/);
      const pubDateMatch = item.match(/<pubDate>(.*?)<\/pubDate>/);
      const descriptionMatch = item.match(/<description><!\[CDATA\[(.*?)\]\]><\/description>/);
      const categoryMatches = item.match(/<category><!\[CDATA\[(.*?)\]\]><\/category>/g) || [];

      return {
        title: titleMatch ? titleMatch[1] : 'Untitled',
        link: linkMatch ? linkMatch[1] : '#',
        pubDate: pubDateMatch ? pubDateMatch[1] : '',
        description: descriptionMatch ? descriptionMatch[1].replace(/<[^>]*>/g, '').substring(0, 150) + '...' : '',
        categories: categoryMatches.map(cat => {
          const match = cat.match(/<category><!\[CDATA\[(.*?)\]\]><\/category>/);
          return match ? match[1] : '';
        }).slice(0, 3)
      };
    });
  }
} catch (error) {
  console.error('Error fetching Medium blogs:', error);
}

function formatDate(dateString: string) {
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
}
---

<section id="blogs" class="py-20 md:py-32 bg-[var(--secondary-background)] px-6 md:px-12">
  <div class="max-w-6xl mx-auto">
    <div class="text-center mb-16 scroll-reveal">
      <p class="text-sm text-[var(--muted)] tracking-widest uppercase mb-4">Insights</p>
      <h2 class="text-4xl md:text-[52px] font-[var(--font-heading)] text-[var(--secondary-foreground)] leading-tight">
        Latest Blog Posts
      </h2>
      <div class="w-16 h-[2px] bg-[var(--secondary-foreground)] mx-auto mt-4"></div>
    </div>

    <div class="grid md:grid-cols-3 gap-8">
      {blogs.map((blog, index) => (
        <a
          href={blog.link}
          target="_blank"
          rel="noopener noreferrer"
          class="group block bg-[var(--background)] overflow-hidden hover:shadow-2xl hover:-translate-y-2 transition-all duration-500 blog-card"
          style={`animation-delay: ${index * 0.2}s`}
        >
          <div class="aspect-[16/9] bg-[var(--accent)] relative overflow-hidden">
            <div class="absolute inset-0 bg-gradient-to-br from-[var(--foreground)] to-transparent opacity-20 group-hover:opacity-40 transition-opacity duration-500"></div>
            <div class="absolute top-4 right-4 text-[var(--foreground)] opacity-50 group-hover:opacity-100 transition-opacity duration-300">
              <span class="text-2xl font-[var(--font-heading)]">0{index + 1}</span>
            </div>
            <div class="absolute bottom-4 left-4 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
              <svg class="w-6 h-6 text-[var(--foreground)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
            </div>
          </div>

          <div class="p-6 space-y-4">
            <div class="space-y-2">
              {blog.pubDate && (
                <p class="text-xs text-[var(--muted-foreground)] tracking-wide uppercase">
                  {formatDate(blog.pubDate)}
                </p>
              )}
              <h3 class="text-xl font-[var(--font-heading)] text-[var(--foreground)] group-hover:text-[var(--accent)] transition-colors line-clamp-2 leading-tight">
                {blog.title}
              </h3>
            </div>

            <p class="text-[var(--muted-foreground)] text-sm line-clamp-3 leading-relaxed">
              {blog.description}
            </p>

            {blog.categories && blog.categories.length > 0 && (
              <div class="flex flex-wrap gap-2">
                {blog.categories.map((category: string) => (
                  <span class="text-xs text-[var(--muted-foreground)] opacity-60">
                    #{category}
                  </span>
                ))}
              </div>
            )}

            <div class="pt-2 flex items-center gap-2 text-[var(--foreground)] group-hover:gap-3 transition-all">
              <span class="text-sm font-medium">
                Read More
              </span>
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </div>
          </div>
        </a>
      ))}
    </div>

    <div class="text-center mt-12 scroll-reveal">
      <a
        href={mediumUrl}
        target="_blank"
        rel="noopener noreferrer"
        class="inline-block px-8 py-3 border-2 border-[var(--secondary-foreground)] text-[var(--secondary-foreground)] font-medium hover:bg-[var(--secondary-foreground)] hover:text-[var(--secondary-background)] hover:scale-105 transition-all duration-300"
      >
        View All Posts
      </a>
    </div>
  </div>
</section>

<style>
  .scroll-reveal {
    opacity: 0;
    animation: fadeInUp 0.8s ease-out forwards;
    animation-timeline: view();
    animation-range: entry 0% cover 30%;
  }

  .blog-card {
    opacity: 0;
    animation: fadeInUp 0.8s ease-out forwards;
    animation-timeline: view();
    animation-range: entry 0% cover 25%;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
