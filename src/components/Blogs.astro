---
import { Image } from 'astro:assets';

const { mediumUrl } = Astro.props;

interface BlogPost {
  title: string;
  link: string;
  pubDate: string;
  description: string;
  categories: string[];
}

let blogs: BlogPost[] = [];

try {
  const username = mediumUrl.replace('https://', '').replace('.medium.com', '').replace('medium.com/@', '');
  const rssFeedUrl = `https://medium.com/feed/@${username}`;

  const response = await fetch(rssFeedUrl);
  if (response.ok) {
    const xmlText = await response.text();

    const items = xmlText.match(/<item>[\s\S]*?<\/item>/g) || [];

    blogs = items.slice(0, 3).map(item => {
      const titleMatch = item.match(/<title><!\[CDATA\[(.*?)\]\]><\/title>/);
      const linkMatch = item.match(/<link>(.*?)<\/link>/);
      const pubDateMatch = item.match(/<pubDate>(.*?)<\/pubDate>/);
      const descriptionMatch = item.match(/<description><!\[CDATA\[(.*?)\]\]><\/description>/);
      const categoryMatches = item.match(/<category><!\[CDATA\[(.*?)\]\]><\/category>/g) || [];

      return {
        title: titleMatch ? titleMatch[1] : 'Untitled',
        link: linkMatch ? linkMatch[1] : '#',
        pubDate: pubDateMatch ? pubDateMatch[1] : '',
        description: descriptionMatch ? descriptionMatch[1].replace(/<[^>]*>/g, '').substring(0, 150) + '...' : '',
        categories: categoryMatches.map(cat => {
          const match = cat.match(/<category><!\[CDATA\[(.*?)\]\]><\/category>/);
          return match ? match[1] : '';
        }).slice(0, 3)
      };
    });
  }
} catch (error) {
  console.error('Error fetching Medium blogs:', error);
}

function formatDate(dateString: string) {
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
}

const blogImages = [
  '/images/Rain-Kissed Reflections on an Ancient Street.png',
  '/images/Holi Joy_ A Vibrant Portrait of Celebration.png',
  '/images/Angkor Wat Sunrise Serenity.png'
];
---

<section id="blogs" class="py-20 md:py-32 bg-[var(--secondary-background)] px-6 md:px-12 relative overflow-hidden" aria-labelledby="blogs-heading">
  <div class="absolute inset-0 pointer-events-none overflow-hidden" aria-hidden="true">
    <p class="blogs-blur-text absolute top-1/4 -left-28 text-[24vw] font-[var(--font-heading)] text-[var(--secondary-foreground)] opacity-[0.02] font-bold leading-none whitespace-nowrap">
      INSIGHTS
    </p>
    <p class="blogs-blur-text-2 absolute bottom-1/3 -right-24 text-[20vw] font-[var(--font-heading)] text-[var(--secondary-foreground)] opacity-[0.025] font-bold leading-none whitespace-nowrap">
      WRITINGS
    </p>
  </div>

  <div class="absolute top-24 right-16 w-44 h-44 rounded-full border-2 border-[var(--muted)] opacity-10 badge-float" aria-hidden="true"></div>
  <div class="absolute bottom-16 left-20 w-52 h-52 bg-[var(--muted)] opacity-5 rotate-45 shape-rotate" aria-hidden="true"></div>

  <div class="max-w-6xl mx-auto relative z-10">
    <header class="text-center mb-16 blogs-header">
      <p class="text-sm text-[var(--muted)] tracking-widest uppercase mb-4">Insights</p>
      <h2 id="blogs-heading" class="text-4xl md:text-[52px] font-[var(--font-heading)] text-[var(--secondary-foreground)] leading-tight">
        Latest Blog Posts
      </h2>
      <div class="w-16 h-[2px] bg-[var(--secondary-foreground)] mx-auto mt-4 blogs-line" aria-hidden="true"></div>
    </header>

    <div class="grid md:grid-cols-3 gap-8 blogs-grid" role="list" aria-label="Latest blog posts from Medium">
      {blogs.map((blog, index) => (
        <article class="blog-card relative h-full" role="listitem" data-index={index}>
          <a
            href={blog.link}
            target="_blank"
            rel="noopener noreferrer"
            class="group flex flex-col h-full bg-[var(--background)] overflow-hidden shadow-xl hover:shadow-2xl hover:-translate-y-3 transition-all duration-500"
            aria-label={`Read ${blog.title} on Medium. Published ${formatDate(blog.pubDate)}`}
          >
            <!-- Decorative corner accent -->
            <div class="absolute top-0 left-0 w-16 h-16 bg-gradient-to-br from-[var(--accent)] to-transparent opacity-0 group-hover:opacity-30 transition-opacity duration-300 z-10" aria-hidden="true"></div>
          <div class="aspect-[16/9] bg-[var(--accent)] relative overflow-hidden">
            <Image
              src={blogImages[index]}
              alt={`Featured image for blog post: ${blog.title}`}
              width={1200}
              height={675}
              class="w-full h-full object-cover"
              loading="lazy"
              quality={85}
            />
            <div class="absolute inset-0 bg-gradient-to-br from-[var(--foreground)] to-transparent opacity-20 group-hover:opacity-40 transition-opacity duration-500"></div>
            <div class="absolute top-4 right-4 text-[var(--foreground)] opacity-50 group-hover:opacity-100 transition-opacity duration-300">
              <span class="text-2xl font-[var(--font-heading)]">0{index + 1}</span>
            </div>
            <div class="absolute bottom-4 left-4 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
              <svg class="w-6 h-6 text-[var(--foreground)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
            </div>
          </div>

          <div class="p-6 space-y-4 flex-1 flex flex-col">
            <div class="space-y-2">
              {blog.pubDate && (
                <p class="text-xs text-[var(--muted-foreground)] tracking-wide uppercase">
                  {formatDate(blog.pubDate)}
                </p>
              )}
              <h3 class="text-xl font-[var(--font-heading)] text-[var(--foreground)] group-hover:text-[var(--accent)] transition-colors line-clamp-2 leading-tight">
                {blog.title}
              </h3>
            </div>

            <p class="text-[var(--muted-foreground)] text-sm line-clamp-3 leading-relaxed">
              {blog.description}
            </p>

            {blog.categories && blog.categories.length > 0 && (
              <div class="flex flex-wrap gap-2">
                {blog.categories.map((category: string) => (
                  <span class="text-xs text-[var(--muted-foreground)] opacity-60">
                    #{category}
                  </span>
                ))}
              </div>
            )}

            <div class="flex-1"></div>

            <div class="pt-2 flex items-center gap-2 text-[var(--foreground)] group-hover:gap-3 transition-all">
              <span class="text-sm font-medium">
                Read More
              </span>
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </div>
          </div>
          </a>
        </article>
      ))}
    </div>

    <div class="text-center mt-12 blogs-button">
      <a
        href={mediumUrl}
        target="_blank"
        rel="noopener noreferrer"
        class="inline-block px-8 py-3 border-2 border-[var(--secondary-foreground)] text-[var(--secondary-foreground)] font-medium hover:bg-[var(--secondary-foreground)] hover:text-[var(--secondary-background)] hover:scale-105 hover:shadow-xl transition-all duration-300 relative overflow-hidden group"
      >
        <span class="relative z-10">View All Posts</span>
        <div class="absolute inset-0 bg-[var(--muted)] transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300 origin-right"></div>
      </a>
    </div>
  </div>
</section>

<script>
  import { gsap } from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';

  gsap.registerPlugin(ScrollTrigger);

  const blogsTl = gsap.timeline({
    scrollTrigger: {
      trigger: '#blogs',
      start: 'top 80%',
      end: 'bottom 20%',
      toggleActions: 'play none none reverse'
    },
    defaults: { ease: 'power3.out' }
  });

  blogsTl
    .fromTo('.blogs-header',
      { y: 60, opacity: 0 },
      { y: 0, opacity: 1, duration: 0.6 }
    )
    .fromTo('.blogs-line',
      { width: 0 },
      { width: '4rem', duration: 0.4 },
      '-=0.3'
    )
    .fromTo('.blog-card',
      { y: 60, opacity: 0, scale: 0.9 },
      { y: 0, opacity: 1, scale: 1, duration: 0.5, stagger: 0.1, ease: 'back.out(1.2)' },
      '-=0.2'
    )
    .fromTo('.blogs-button',
      { y: 30, opacity: 0 },
      { y: 0, opacity: 1, duration: 0.4 },
      '-=0.2'
    );

  gsap.to('.blogs-blur-text', {
    x: -200,
    scrollTrigger: {
      trigger: '#blogs',
      start: 'top bottom',
      end: 'bottom top',
      scrub: 1
    }
  });

  gsap.to('.blogs-blur-text-2', {
    x: 200,
    scrollTrigger: {
      trigger: '#blogs',
      start: 'top bottom',
      end: 'bottom top',
      scrub: 1
    }
  });
</script>

<style>
  @keyframes badgeFloat {
    0%, 100% {
      transform: translateY(0) scale(1);
    }
    50% {
      transform: translateY(-35px) scale(1.03);
    }
  }

  @keyframes shapeRotate {
    from {
      transform: rotate(45deg);
    }
    to {
      transform: rotate(405deg);
    }
  }

  .badge-float {
    animation: badgeFloat 12s ease-in-out infinite;
  }

  .shape-rotate {
    animation: shapeRotate 35s linear infinite;
  }
</style>
