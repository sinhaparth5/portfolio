---
import { Image } from 'astro:assets';

const { username } = Astro.props;

interface GitHubRepo {
  name: string;
  description: string;
  html_url: string;
  homepage: string;
  stargazers_count: number;
  language: string;
  updated_at: string;
  topics: string[];
}

let projects: GitHubRepo[] = [];

try {
  const response = await fetch(`https://api.github.com/users/${username}/repos?sort=updated&per_page=100`);
  if (response.ok) {
    const repos: GitHubRepo[] = await response.json();
    projects = repos
      .filter((repo: any) => !repo.fork)
      .slice(0, 3);
  }
} catch (error) {
  console.error('Error fetching GitHub repos:', error);
}

const projectImages = [
  '/images/Urban Internet Caf√© at Twilight.png',
  '/images/Futuristic Portrait.png',
  '/images/Traditional Woman Portrait.png'
];
---

<section id="projects" class="py-20 md:py-32 bg-[var(--background)] px-6 md:px-12 relative overflow-hidden" aria-labelledby="projects-heading">
  <div class="absolute inset-0 pointer-events-none overflow-hidden" aria-hidden="true">
    <p class="projects-blur-text absolute top-1/3 -left-24 text-[22vw] font-[var(--font-heading)] text-[var(--foreground)] opacity-[0.02] font-bold leading-none whitespace-nowrap">
      PORTFOLIO
    </p>
    <p class="projects-blur-text-2 absolute bottom-1/4 -right-20 text-[18vw] font-[var(--font-heading)] text-[var(--foreground)] opacity-[0.025] font-bold leading-none whitespace-nowrap">
      WORKS
    </p>
  </div>

  <div class="absolute top-16 right-20 w-48 h-48 border-2 border-[var(--accent)] opacity-10 rotate-12 shape-rotate" aria-hidden="true"></div>
  <div class="absolute bottom-20 left-12 w-36 h-36 rounded-full bg-[var(--accent)] opacity-5 badge-float" aria-hidden="true"></div>

  <div class="max-w-6xl mx-auto relative z-10">
    <header class="text-center mb-16 projects-header">
      <p class="text-sm text-[var(--muted-foreground)] tracking-widest uppercase mb-4">Portfolio</p>
      <h2 id="projects-heading" class="text-4xl md:text-[52px] font-[var(--font-heading)] text-[var(--foreground)] leading-tight">
        Featured Projects
      </h2>
      <div class="w-16 h-[2px] bg-[var(--foreground)] mx-auto mt-4 projects-line" aria-hidden="true"></div>
    </header>

    <div class="grid md:grid-cols-3 gap-8 projects-grid" role="list" aria-label="Featured projects">
      {projects.map((project, index) => (
        <article class="project-card relative h-full" role="listitem" data-index={index}>
          <a
            href={project.html_url}
            target="_blank"
            rel="noopener noreferrer"
            class="group flex flex-col h-full bg-[var(--secondary-background)] overflow-hidden shadow-xl hover:shadow-2xl hover:-translate-y-3 transition-all duration-500"
            aria-label={`View ${project.name.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')} project on GitHub - ${project.description || 'A project showcasing modern development practices'}`}
          >
            <!-- Decorative corner element -->
            <div class="absolute top-0 right-0 w-12 h-12 bg-[var(--accent)] opacity-0 group-hover:opacity-20 transition-opacity duration-300 z-10" aria-hidden="true"></div>
            <div class="aspect-[4/3] bg-[var(--accent)] relative overflow-hidden">
              <Image
                src={projectImages[index]}
                alt={`${project.name.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')} project screenshot`}
                width={800}
                height={600}
                class="w-full h-full object-cover"
                loading="lazy"
                quality={85}
              />
              <div class="absolute inset-0 bg-gradient-to-br from-[var(--secondary-foreground)] to-transparent opacity-0 group-hover:opacity-30 transition-opacity duration-500" aria-hidden="true"></div>
              <div class="absolute bottom-4 right-4 text-[var(--secondary-foreground)] opacity-50 group-hover:opacity-100 transition-opacity duration-300" aria-hidden="true">
                <span class="text-2xl font-[var(--font-heading)]">0{index + 1}</span>
              </div>
              <div class="absolute top-4 left-4 opacity-0 group-hover:opacity-100 transition-opacity duration-300" aria-hidden="true">
                <svg class="w-6 h-6 text-[var(--secondary-foreground)]" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                </svg>
              </div>
            </div>

          <div class="p-6 space-y-4 flex-1 flex flex-col">
            <div class="flex items-start justify-between gap-4">
              <h3 class="text-xl font-[var(--font-heading)] text-[var(--secondary-foreground)] group-hover:text-[var(--muted)] transition-colors">
                {project.name.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')}
              </h3>
              {project.language && (
                <span class="text-xs text-[var(--muted)] px-2 py-1 border border-[var(--muted)] whitespace-nowrap">
                  {project.language}
                </span>
              )}
            </div>

            <p class="text-[var(--muted)] text-sm line-clamp-3 leading-relaxed">
              {project.description || 'A project showcasing modern development practices and clean code.'}
            </p>

            {project.topics && project.topics.length > 0 && (
              <div class="flex flex-wrap gap-2">
                {project.topics.slice(0, 3).map((topic: string) => (
                  <span class="text-xs text-[var(--muted)] opacity-60">
                    #{topic}
                  </span>
                ))}
              </div>
            )}

            <div class="flex-1"></div>

            <div class="flex items-center gap-4 pt-2 text-[var(--muted)] text-xs">
              <span class="flex items-center gap-1" aria-label={`${project.stargazers_count} stars on GitHub`}>
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                </svg>
                <span aria-hidden="true">{project.stargazers_count}</span>
              </span>
            </div>
          </div>
          </a>
        </article>
      ))}
    </div>

    <div class="text-center mt-12 projects-button">
      <a
        href={`https://github.com/${username}`}
        target="_blank"
        rel="noopener noreferrer"
        class="inline-block px-8 py-3 border-2 border-[var(--foreground)] text-[var(--foreground)] font-medium hover:bg-[var(--foreground)] hover:text-[var(--background)] hover:scale-105 hover:shadow-xl transition-all duration-300 relative overflow-hidden group"
      >
        <span class="relative z-10">View All Projects</span>
        <div class="absolute inset-0 bg-[var(--accent)] transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300 origin-left"></div>
      </a>
    </div>
  </div>
</section>

<script>
  import { gsap } from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';

  gsap.registerPlugin(ScrollTrigger);

  const projectsTl = gsap.timeline({
    scrollTrigger: {
      trigger: '#projects',
      start: 'top 80%',
      end: 'bottom 20%',
      toggleActions: 'play none none reverse'
    },
    defaults: { ease: 'power3.out' }
  });

  projectsTl
    .fromTo('.projects-header',
      { y: 60, opacity: 0 },
      { y: 0, opacity: 1, duration: 0.6 }
    )
    .fromTo('.projects-line',
      { width: 0 },
      { width: '4rem', duration: 0.4 },
      '-=0.3'
    )
    .fromTo('.project-card',
      { y: 60, opacity: 0, scale: 0.9 },
      { y: 0, opacity: 1, scale: 1, duration: 0.5, stagger: 0.1, ease: 'back.out(1.2)' },
      '-=0.2'
    )
    .fromTo('.projects-button',
      { y: 30, opacity: 0 },
      { y: 0, opacity: 1, duration: 0.4 },
      '-=0.2'
    );

  gsap.to('.projects-blur-text', {
    x: -180,
    scrollTrigger: {
      trigger: '#projects',
      start: 'top bottom',
      end: 'bottom top',
      scrub: 1
    }
  });

  gsap.to('.projects-blur-text-2', {
    x: 180,
    scrollTrigger: {
      trigger: '#projects',
      start: 'top bottom',
      end: 'bottom top',
      scrub: 1
    }
  });
</script>

<style>
  @keyframes badgeFloat {
    0%, 100% {
      transform: translateY(0);
    }
    50% {
      transform: translateY(-25px);
    }
  }

  @keyframes shapeRotate {
    from {
      transform: rotate(12deg);
    }
    to {
      transform: rotate(372deg);
    }
  }

  .badge-float {
    animation: badgeFloat 10s ease-in-out infinite;
  }

  .shape-rotate {
    animation: shapeRotate 30s linear infinite;
  }
</style>
